name: CI/CD Pipeline

on:
  push:
    branches:
      - main # Change from test-ci-cd to main when ready for production

jobs:

  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    # Store the SSH private key in GitHub secrets
    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Debug SSH Connection
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }} 
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        ssh -v -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "echo Connected successfully"

    - name: SSH into EC2 and Deploy
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        ENV_FILE: ${{ secrets.ENV_FILE }} # Store .env file in GitHub secrets
      run: |
        # Navigate to the application directory
        cd ~/redd_chatbot_new

        # Pull the latest code from the main branch
        git pull origin main
        
        # Build the Docker image
        docker build -t streamlit-app .

        # Stop and remove any existing container with the same name
        docker stop streamlit-app || true
        docker rm streamlit-app || true

        # Run the Docker container with environment variables and restart policy
        docker run -d -p 8501:8501 \
          --name streamlit-app \
          --env-file $ENV_FILE \ # Load environment variables from the stored .env file
          --restart unless-stopped \
          streamlit-app